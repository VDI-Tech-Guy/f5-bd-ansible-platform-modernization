---

- name: Check if host is online (port open)
  ansible.builtin.wait_for:
    host: "{{ ansible_host }}"
    port: 22
    state: started  # port is OPEN
    timeout: 5
    connect_timeout: 2
  register: port_up_check
  ignore_errors: true
  delegate_to: localhost

- name: Fail when host is still online
  ansible.builtin.fail:
    msg: "Host is still online (port 22 reachable)"
  when: port_up_check is not failed
  retries: 30
  delay: 10
  until: port_up_check is failed
